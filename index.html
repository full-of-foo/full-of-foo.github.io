
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->

<head>


<meta charset="utf-8">
<meta http-equiv="cleartype" content="on">

<title>(╯°□°）╯︵ ┻━┻ toeknee land</title>
<meta name="author" content="- Proud Torrenter of Software - All Rights Reserved">





<meta name="description" content="


  




  
    
      
        March 12, 2017
      
    

    
      &nbsp; &bull; &nbsp;
        Comment
      
    
  
  
    
      Mutation ...">

<meta name="keywords" content=" blog ruby rails javascript coffeescript backbone modern tech hacks dublin">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Twitter Cards -->

  
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/images/bg.png"
  
  <meta name="twitter:title" content="toeknee land">
  <meta name="twitter:description" content="


  




  
    
      
        March 12, 2017
      
    

    
      &nbsp; &bull; &nbsp;
        Comment
      
    
  
  
    
      Mutation ...">
  <meta name="twitter:creator" content="@devtoeknee">


<!-- Open Graph -->
<meta property="og:local" content="en_US">
<meta property="og:type" content="article">
<meta property="og:url" content="http://page.url | remove:">
<meta property="og:title" content="toeknee land">
<meta property="og:description" content="


  




  
    
      
        March 12, 2017
      
    

    
      &nbsp; &bull; &nbsp;
        Comment
      
    
  
  
    
      Mutation ...">

  <meta property="og:image" content="/images/bg.png">

<meta property="og:site_name" content="toeknee land">

<link rel="canonical" href="/">
<link href="/favicon.png" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="http://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
<link href="/atom.xml" rel="alternate" title="toeknee land" type="application/atom+xml">
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script src="/javascripts/vendor/modernizr-2.6.2.custom.min.js"></script>



<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">


</head>

<body id="post-index" class="feature">
  <!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
  <nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="/images/avatar.jpg" alt="- Proud Torrenter of Software - All Rights Reserved photo" class="author-photo">
					<h4>- Proud Torrenter of Software - All Rights Reserved</h4>
					<p>Code Pirate, </br>Project Monkey</p>
				</li>
				<li><a target="_blank" href="//ie.linkedin.com/pub/anthony-troy/62/40a/743">Learn More</a></li>
				
				<li>
					<a target="_blank" href="http://twitter.com/devtoeknee"><i class="fa fa-twitter"></i> Twitter</a>
				</li>
				
				<li>
					<a target="_blank" href="http://github.com/full-of-foo"><i class="fa fa-github"></i> GitHub</a>
				</li>
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="/posts/">All Posts</a></li>
				<li><a href="/categories/">All Categories</a></li>
			</ul>
		</li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->


  <div class="entry-header">
    
    
      <div class="entry-image">
        <img src="/images/bg.png" alt="">
      </div><!-- /.entry-image -->
    
    <div class="header-title">
      <div class="header-title-wrap">
        <!-- <h1>\(°□°)/</h1> -->
        <h2 style="margin-top: 60px">&#9825; useless tech ramblings &#9825;</h2>
      </div><!-- /.header-title-wrap -->
    </div><!-- /.header-title -->
  </div><!-- /.entry-header -->

  <div id="main" role="main">
    

<article class="hentry">
  



<header>
  <div class="entry-meta">
    <span class="entry-date date published updated">
      <time datetime="2017-03-12T12:17:39+00:00">
        <a href="/blog/2017/03/12/mutation-testing-is-awesome-pit-for-the-jvm/">March 12, 2017</a>
      </time>
    </span>
<!--     <span class="author vcard">
      <span class="fn">
        <a href="" title="About - Proud Torrenter of Software - All Rights Reserved">- Proud Torrenter of Software - All Rights Reserved</a>
      </span>
    </span> -->
    
      &nbsp; &bull; &nbsp;<span class="entry-comments">
        <a href="/blog/2017/03/12/mutation-testing-is-awesome-pit-for-the-jvm/#disqus_thread">Comment</a>
      </span>
    
  </div><!-- /.entry-meta -->
  
    <h1 class="entry-title">
      <a href="/blog/2017/03/12/mutation-testing-is-awesome-pit-for-the-jvm/" rel="bookmark" title="Mutation Testing is Awesome: PIT for the JVM" itemprop="url">Mutation Testing is Awesome: PIT for the JVM</a>
    </h1>
  
</header>

<div class="entry-content">
  <p><img src="/images/dil.jpg" alt="dil" /></p>

<p>Nowadays its not all that popular to be a testing enthusiast or fanatic.</p>

<p>After all, <a href="http://removingalldoubt.com/post/2006/09/19/Fatherly-Advice-To-New-Programmers.aspx">real developers ship</a> and <a href="http://david.heinemeierhansson.com/2014/tdd-is-dead-long-live-testing.html">TDD is dead</a>, so developers ought to spend
less time getting caught up in testing-related hogwash and instead focus on the immediate
churning out of what is at hand. Be <a href="https://thenewstack.io/10x-programmer-just-jerk/">10x</a>, <a href="https://xkcd.com/1428/">move fast and break things</a>, pew pew pew, and so on, and so on.</p>

<p><img src="/images/neck.png" alt="neck" />
Free time from shipping our way to <a href="https://en.wikipedia.org/wiki/Unicorn_(finance)">software unicorn</a> land is often spent perusing
blog posts from high-culture <a href="https://news.ycombinator.com">engineering forums</a>. In doing so you
may have stumbled upon this strange blog, and, much too your dismay we&rsquo;ll be getting into plenty of
1x testing nonsense. <em>Sarcasm</em> aside, here we&rsquo;re going to explore and demonstrate some things like <a href="https://en.wikipedia.org/wiki/Mutation_testing">Mutation Testing</a>, <a href="http://mcminn.io/publications/j18.pdf">Code Coverage</a> and <a href="http://patricklam.ca/stqam/2010/notes/pdf/L3.pdf">Subsumption</a>.</p>

<p>The hope is to possibly convince you that (in general) code coverage is useful, and moreover, that mutation coverage testing is both awesome and practical.</p>

<p>- Buckle up buckaroos.</p>

<h2>Back to Basics, Yo</h2>

<p>Remember, you might want to begin rolling your eyes when you hear the terms &ldquo;complete testing&rdquo;, &ldquo;exhaustive testing&rdquo;, and &ldquo;full coverage&rdquo;. They are each poorly defined due to a
theoretical limitation of software - the number of potential
inputs for most programs is so large that they are effectively infinite.</p>

<p><img src="/images/rly.png" alt="rly" />
Consider <code>javac</code>. As a software artifact its potential inputs include not only every Java
program, but all strings. Its only limitation is the size of the file that can be read by the parser. Therefore, the number of inputs is effectively infinite and cannot be explicitly enumerated. It can never have &ldquo;full coverage&rdquo;.</p>

<p>Enter formal <a href="http://mcminn.io/publications/j18.pdf">coverage criteria</a>. As it is not feasible to generate all test inputs,
coverage criteria can be used to decide our inputs. The supposition here is that
coverage criteria will more effectively reveal faults (over using <code>n</code> arbitrary inputs).
Albeit expensive, the most obvious way to use criteria is to directly generate test case values
to satisfy the criterion <code>C</code>.</p>

<p>However, in practice we generally manually create an arbitrary amount of pseudo-random inputs, and then measure the tests against the criterion in terms of their coverage.
On the surface this understandable. Generating tests to directly satisfy
a criterion is hard, really hard. This particularly true when attempting generate test paths
for <a href="http://swtv.kaist.ac.kr/courses/cs453-fall09/graph_coverage.pdf">graph coverage criteria</a>.</p>

<p>Not all is lost though. More flexible criteria do exist which, more importantly, can actually be used sustainably against real programs.</p>

<h2>Kanye test Grammar?</h2>

<p>The most common coverage criteria generate tests to satisfy their criterion based on either graphs, logical expressions, or partitions of input space. Graph and logical models are built from software artifacts (such as source code, design descriptions and specifications). Similarly, a model of the inputs can be built based on some description of an input space. Test criteria can then be applied to these models.
<img src="/images/kanye.png" alt="kanye" /></p>

<p>Another major method of deriving coverage criteria is though the syntactic descriptions of software artifacts. Under syntax-based testing, the syntax of the software artifact is used as the
criteria model and tests are created from the syntax (ie. covering or violating the syntax in some way). So simply, by virtue a grammar describes what a test input <em>is not</em>. We say that an input is valid if it is <em>in the language</em> specified by the grammar, and
invalid otherwise.</p>

<p>Thus, it is often useful to produce invalid strings from a grammar. It is also helpful
in testing to use strings that are valid but that follow a different derivation from
a pre-existing string. This general use of grammar in testing is known as
mutation analysis, and it can be applied most types of software artifacts.</p>

<p>Albeit this all quite theoretical feeling thus far, mutation analysis has paved the
way for what is currently argued to be the <a href="http://crestweb.cs.ucl.ac.uk/resources/mutation_testing_repository/search_paper.php?func=2&amp;pid=OffuttMK04">gold standard</a> in software testing; <a href="https://en.wikipedia.org/wiki/Mutation_testing">Program-based Mutation Testing</a>.</p>

<h2>Mutant Ninja Testing</h2>

<p>Although mutation testing sounds somewhat highbrow, its conceptually quite simple.
Faults, or <em>mutations</em>, are injected into one&rsquo;s testing target, and when those tests are ran there are total and per case mutation adequacy scores derived. Under most systems, given those tests have failed then the mutation is <em>killed</em> and if they have passed then the mutation has <em>survived</em>.
In turn, this total percentage of mutations killed acts as a testing criterion for
test case quality.</p>

<p>So, unlike traditional test coverage criteria that only measure which code is executed
by your tests, mutation testing actually measures the ability of your tests in revealing faults.
This premise of mutation testing is intuitively appealing; we can discover the input
data that can be used to reveal real faults. Nevertheless, as highlighted earlier, it is
not possible for any system to generate every possible permutation of
mutant in a candidate program.</p>

<p><img src="/images/turt.png" alt="turt" />
Consequently, mutation testing systems will only offer a finite set of injectable mutators. So, hopeful that these finite amount mutators will reveal faults, mutation testing can be
said to rely on two assumptions: the <a href="https://edisciplinas.usp.br/pluginfile.php/1943431/mod_resource/content/1/Hints_on_Test_Data_Selection-Demillo.pdf">Competent Programmer Hypothesis (CPH)
and Coupling Effect</a>.</p>

<p>The CPH asserts that a program produced by a competent programmer is
close to the final correct version of a program. Thus, it is assumed that the
source faults introduced by a competent programmer are relatively simple and
can be corrected by small syntactical changes. Accordingly, in mutation testing
only simple syntactical mutations are generally used. Contrarily, the Coupling
Effect brings the suggestion that tests capable of catching first order mutations
will also detect higher order mutations that contain these first order mutations.</p>

<h2>Strong and Weak Mutations</h2>

<p>The implementation of mutation testing systems
are generally characterised in terms of their adopted mutation generation techniques.
Another distinction can be made with respect to
how a given tool analyses how mutants are killed during the execution process.
Such techniques can be classified as employing strong or weak mutation.
Under strong mutation given program <em>p</em>, a
mutant <em>m</em> of program <em>p</em> is said to be killed only if mutant <em>m</em> gives a different
output from the original program <em>p</em>.
<img src="/images/jug.png" alt="jug" /></p>

<p>In contrast, weak mutation requires only that the value produced at the point
we introduce <em>m</em> is different from the corresponding value in <em>p</em> for <em>m</em> to be killed.
This more optimal approach is adopted by tools such as <a href="http://pitest.org">PIT</a>; instead of analysing each mutant after the execution of the entire run,
mutants are checked immediately after their respective execution point.</p>

<h2>Killing Mutants with PIT: (╯°□°)&ndash;︻╦╤─ - - -</h2>

<p><a href="http://pitest.org">PIT</a> is an <a href="https://github.com/hcoles/pitest">open-source</a> mutation testing framework
for Java and the JVM. Formerly being named Parallel Isolated Test, the project&rsquo;s
initial function was to isolate static state through running JUnit tests in parallel
using separate classloaders, however the author later found that this turned out
to be a much less interesting problem than mutation testing which initially
needed a lot of the same plumbing.</p>

<p>Most importantly, as far as mutation testing projects go, PIT is <a href="http://pitest.org/sky_experience/">commercially popular</a>
and <a href="https://github.com/hcoles/pitest/releases">actively contributed to</a>. As you would expect, it too has first-class support for
the things like JUnit4, TestNg, Ant and Maven. Third-party support does also exist
for Gradle, Eclipse and InteliJ integrations.</p>

<p>In terms of design, mutation testing systems generally derive adequacy scores in four phases:
mutant generation, test selection, mutant insertion and mutant detection. PIT parallelises
these phases, making a mutation coverage run feel almost like a traditional statement coverage run.
Most testing frameworks in this space have adopted varying strategies in implementing each of
these phases. One reason for this disparity could be that many
JVM-based mutation testing systems have been written to meet the needs of
academic research.</p>

<p>PIT is currently positioned as being the most performant mutation testing tool
today, primarily due to fact that it adopts an effective byte code based approach in the mutant detection and generation phases. Generally systems will adopt either a source code or byte
based approach at these stages. Using byte code during the mutation detection phase
is quite computationally expensive, though this can be offset by an effective test
selection phase.
<img src="/images/doge2.png" alt="doge2" /></p>

<p>Additionally, systems using source code at the generation stage
can also incur a large computational cost if a naive approach is followed. Tools
like <a href="https://cs.gmu.edu/~offutt/mujava/">MuJava</a>, <a href="https://github.com/david-schuler/javalanche">Javalanche</a> and <a href="http://jumble.sourceforge.net/">Jumble</a> too use byte code generation, however PIT performs various other optimisations. Rather than blindly running all cases against one mutation PIT will
first determine overall line coverage and subsequently run only those cases that
can actually reach the mutation.</p>

<h2>The Super Complicated Test Candidate</h2>

<p>Most tech blogs love using real-world code examples, so lets not be an exception to
that rule. Here we define a program that
allows one <a href="http://russcon.org/triangle_classification.html">classify a triangle</a> shape based on three supplied coordinates. A classification can be either equilateral, isosceles, scalene or invalid. Accordingly we implement a <code>TriangleType</code>
enum and following we define our <code>Triangle</code> class with one static method for classification.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">enum</span> <span class="n">TriangleType</span> <span class="o">{</span>
  <span class="n">INVALID</span><span class="o">,</span> <span class="n">SCALENE</span><span class="o">,</span> <span class="n">EQUILATERAL</span><span class="o">,</span> <span class="n">ISOSCELES</span>
<span class="o">}</span></code></pre></div>




<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Triangle</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">TriangleType</span> <span class="nf">classify</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">a</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">trian</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">a</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">b</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">TriangleType</span><span class="o">.</span><span class="na">INVALID</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">trian</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">trian</span> <span class="o">=</span> <span class="n">trian</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">trian</span> <span class="o">=</span> <span class="n">trian</span> <span class="o">+</span> <span class="mi">2</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">b</span> <span class="o">==</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">trian</span> <span class="o">=</span> <span class="n">trian</span> <span class="o">+</span> <span class="mi">3</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">trian</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(((</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">||</span> <span class="o">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">c</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">)</span> <span class="o">||</span> <span class="o">((</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">TriangleType</span><span class="o">.</span><span class="na">INVALID</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">TriangleType</span><span class="o">.</span><span class="na">SCALENE</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">trian</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">TriangleType</span><span class="o">.</span><span class="na">EQUILATERAL</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">trian</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">TriangleType</span><span class="o">.</span><span class="na">ISOSCELES</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">trian</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">c</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">TriangleType</span><span class="o">.</span><span class="na">ISOSCELES</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">trian</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">((</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">a</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">TriangleType</span><span class="o">.</span><span class="na">ISOSCELES</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">TriangleType</span><span class="o">.</span><span class="na">INVALID</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div>


<p>We also implement a <code>TriangleTest</code> case, and because we&rsquo;re good testers we ensure to meet total line coverage:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TriangleTest</span> <span class="o">{</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">TriangleType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Triangle</span><span class="o">.</span><span class="na">classify</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">SCALENE</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInvalid1</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">TriangleType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Triangle</span><span class="o">.</span><span class="na">classify</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">INVALID</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInvalid2</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">TriangleType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Triangle</span><span class="o">.</span><span class="na">classify</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">INVALID</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInvalid3</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">TriangleType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Triangle</span><span class="o">.</span><span class="na">classify</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">INVALID</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInvalidNeg1</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">TriangleType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Triangle</span><span class="o">.</span><span class="na">classify</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">INVALID</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInvalidNeg2</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">TriangleType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Triangle</span><span class="o">.</span><span class="na">classify</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">INVALID</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInvalidNeg3</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">TriangleType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Triangle</span><span class="o">.</span><span class="na">classify</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">INVALID</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testEquiliteral</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">TriangleType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Triangle</span><span class="o">.</span><span class="na">classify</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">EQUILATERAL</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testIsoceles1</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">TriangleType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Triangle</span><span class="o">.</span><span class="na">classify</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">ISOSCELES</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testIsoceles2</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">TriangleType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Triangle</span><span class="o">.</span><span class="na">classify</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">ISOSCELES</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testIsoceles3</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">TriangleType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Triangle</span><span class="o">.</span><span class="na">classify</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">ISOSCELES</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInvalid</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">TriangleType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Triangle</span><span class="o">.</span><span class="na">classify</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">INVALID</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div>


<p>So now lets gets webscale and get our candidate unit tested and mutation tested
under Maven. The <code>pitest</code> artifact and its related dependencies are hosted by Sonatype so we can add the typical <a href="https://github.com/full-of-foo/pit-coverage-tool-review/blob/master/practical/maven-pit-review/pom.xml#L9"><code>oss-sonatype</code></a> <code>repository</code> and <code>pluginRepository</code> entries to our <code>pom.xml</code>. We can then simply  configure PIT under JUnit4 as follows:</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml">...
<span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>4.11<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;build&gt;</span>
    <span class="nt">&lt;plugins&gt;</span>
        <span class="nt">&lt;plugin&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>2.4<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;plugin&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.pitest<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>pitest-maven<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.1.10-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;executions&gt;</span>
                <span class="nt">&lt;execution&gt;</span>
                    <span class="nt">&lt;id&gt;</span>verify<span class="nt">&lt;/id&gt;</span>
                    <span class="nt">&lt;phase&gt;</span>verify<span class="nt">&lt;/phase&gt;</span>
                    <span class="nt">&lt;goals&gt;</span>
                        <span class="nt">&lt;goal&gt;</span>mutationCoverage<span class="nt">&lt;/goal&gt;</span>
                    <span class="nt">&lt;/goals&gt;</span>
                <span class="nt">&lt;/execution&gt;</span>
            <span class="nt">&lt;/executions&gt;</span>
        <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
<span class="nt">&lt;/build&gt;</span>
  ...</code></pre></div>


<p>Unless we configure PIT to employ a <a href="https://github.com/full-of-foo/pit-coverage-tool-review/blob/master/practical/maven-pit-review/all-configs-pom.xml#L75">whitelist of mutation operations</a>,
it will use a default of four default mutation operations. Of a possible sixteen
operations these four are perhaps the most useful and least expensive:</p>

<ol>
<li>Negate Conditionals Mutator inverts all conditionals
to their boundary counterpart.

<ul>
<li><code>boolean a = 1 == 2;</code> becomes mutated to <code>boolean a = 1 != 2;</code></li>
</ul>
</li>
<li>Conditionals Boundary Mutator replaces relational operators
with their boundary counterpart.

<ul>
<li><code>int a = 1 &gt; 2;</code> becomes mutated to <code>int a = 1 &lt;= 2;</code></li>
</ul>
</li>
<li>Return Values Mutator mutates the return values of method calls.

<ul>
<li><code>return new Object();</code> becomes mutated to <code>new Object(); return null;</code></li>
<li><code>return new Long(123);</code> becomes mutated to <code>return new Long(123)+1;</code></li>
</ul>
</li>
<li>Math Mutator replaces binary arithmetic operations for either integer or floating-point arithmetic with another operation.

<ul>
<li><code>int a = 1 + 1</code> becomes mutated to <code>int a = 1 - 1</code></li>
</ul>
</li>
</ol>


<h2>Testing Tests While Testing</h2>

<p>Given our configuration, PIT will now perform mutation testing at end the of the Maven <code>verfiy</code> lifecycle
phases (after <code>test</code>). This involves running both line coverage and mutation coverage testing:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">&gt; <span class="nv">$ </span>mvn verify
            ....
<span class="o">[</span>INFO<span class="o">]</span> Adding org.pitest:pitest to SUT classpath
<span class="o">[</span>INFO<span class="o">]</span> Mutating from /usr/src/app/maven-pit-review/target/classes
<span class="o">[</span>INFO<span class="o">]</span> Defaulting to group id <span class="o">(</span>com.review.app*<span class="o">)</span>
PIT &gt;&gt; INFO : Sending <span class="m">1</span> <span class="nb">test </span>classes to minion
PIT &gt;&gt; INFO : Sent tests to minion
PIT &gt;&gt; INFO : MINION : PIT &gt;&gt; INFO : Checking environment
PIT &gt;&gt; INFO : MINION : PIT &gt;&gt; INFO : Found  <span class="m">12</span> tests
PIT &gt;&gt; INFO : MINION : PIT &gt;&gt; INFO : Dependency analysis reduced number of potential tests by 0
PIT &gt;&gt; INFO : MINION : PIT &gt;&gt; INFO : <span class="m">12</span> tests received
PIT &gt;&gt; INFO : Calculated coverage in <span class="m">0</span> seconds.
PIT &gt;&gt; INFO : Created  <span class="m">1</span> mutation <span class="nb">test </span>units
PIT &gt;&gt; INFO : Completed in <span class="m">3</span> seconds
              ....
<span class="o">================================================================================</span>
- <span class="nv">Statistics</span>
<span class="o">================================================================================</span>
&gt;&gt; Generated <span class="m">44</span> mutations Killed <span class="m">36</span> <span class="o">(</span>82%<span class="o">)</span>
&gt;&gt; Ran <span class="m">115</span> tests <span class="o">(</span>2.61 tests per mutation<span class="o">)</span>
<span class="o">================================================================================</span>
- <span class="nv">Mutators</span>
<span class="o">================================================================================</span>
&gt; org.pitest.mutationtest.engine.gregor.mutators.ConditionalsBoundaryMutator
&gt;&gt; Generated <span class="m">10</span> Killed <span class="m">2</span> <span class="o">(</span>20%<span class="o">)</span>
&gt; KILLED <span class="m">2</span> SURVIVED <span class="m">8</span> TIMED_OUT <span class="m">0</span> NON_VIABLE 0
&gt; MEMORY_ERROR <span class="m">0</span> NOT_STARTED <span class="m">0</span> STARTED <span class="m">0</span> RUN_ERROR 0
&gt; NO_COVERAGE 0
--------------------------------------------------------------------------------
&gt; org.pitest.mutationtest.engine.gregor.mutators.ReturnValsMutator
&gt;&gt; Generated <span class="m">8</span> Killed <span class="m">8</span> <span class="o">(</span>100%<span class="o">)</span>
&gt; KILLED <span class="m">8</span> SURVIVED <span class="m">0</span> TIMED_OUT <span class="m">0</span> NON_VIABLE 0
&gt; MEMORY_ERROR <span class="m">0</span> NOT_STARTED <span class="m">0</span> STARTED <span class="m">0</span> RUN_ERROR 0
&gt; NO_COVERAGE 0
--------------------------------------------------------------------------------
&gt; org.pitest.mutationtest.engine.gregor.mutators.MathMutator
&gt;&gt; Generated <span class="m">9</span> Killed <span class="m">9</span> <span class="o">(</span>100%<span class="o">)</span>
&gt; KILLED <span class="m">9</span> SURVIVED <span class="m">0</span> TIMED_OUT <span class="m">0</span> NON_VIABLE 0
&gt; MEMORY_ERROR <span class="m">0</span> NOT_STARTED <span class="m">0</span> STARTED <span class="m">0</span> RUN_ERROR 0
&gt; NO_COVERAGE 0
--------------------------------------------------------------------------------
&gt; org.pitest.mutationtest.engine.gregor.mutators.NegateConditionalsMutator
&gt;&gt; Generated <span class="m">17</span> Killed <span class="m">17</span> <span class="o">(</span>100%<span class="o">)</span>
&gt; KILLED <span class="m">17</span> SURVIVED <span class="m">0</span> TIMED_OUT <span class="m">0</span> NON_VIABLE 0
&gt; MEMORY_ERROR <span class="m">0</span> NOT_STARTED <span class="m">0</span> STARTED <span class="m">0</span> RUN_ERROR 0
&gt; NO_COVERAGE 0
--------------------------------------------------------------------------------</code></pre></div>


<p>So, who would of guessed, our &ldquo;total covered&rdquo; candidate app yields 44 mutations
but eight survive. Resulting in a total mutation
adequacy score of 82%. The default mutation operations are generated
across our 12 test cases, resulting in the execution of 115 mutated test cases.
So what is this tellings us about our tests? It means for each test run against a mutated version of the program all of the mutants can be reached (because we have full statement coverage). However, for eight of these runs at least the respective fault goes unnoticed as the tests pass.</p>

  
  
</div><!-- /.entry-content -->





</article><!-- /.hentry -->

<article class="hentry">
  



<header>
  <div class="entry-meta">
    <span class="entry-date date published updated">
      <time datetime="2015-08-24T19:56:46+01:00">
        <a href="/blog/2015/08/24/matrix-multiply-naive-vs-cache-aware-approaches-part-2/">August 24, 2015</a>
      </time>
    </span>
<!--     <span class="author vcard">
      <span class="fn">
        <a href="" title="About - Proud Torrenter of Software - All Rights Reserved">- Proud Torrenter of Software - All Rights Reserved</a>
      </span>
    </span> -->
    
      &nbsp; &bull; &nbsp;<span class="entry-comments">
        <a href="/blog/2015/08/24/matrix-multiply-naive-vs-cache-aware-approaches-part-2/#disqus_thread">Comment</a>
      </span>
    
  </div><!-- /.entry-meta -->
  
    <h1 class="entry-title">
      <a href="/blog/2015/08/24/matrix-multiply-naive-vs-cache-aware-approaches-part-2/" rel="bookmark" title="Matrix Multiply: Naive Vs Cache-Aware Approaches (Part 2)" itemprop="url">Matrix Multiply: Naive Vs Cache-Aware Approaches (Part 2)</a>
    </h1>
  
</header>

<div class="entry-content">
  <h2>Matrix Multiplication Feels Bad</h2>

<p>In our <a href="/blog/2015/06/07/matrix-multiply-naive-vs-cache-aware-approaches-1/">last post</a>
we talked about the implications of both sequential and parallel naive <a href="http://en.wikipedia.org/wiki/Matrix_multiplication">Matrix-Matrix multiplication (MMM)</a>. Sadly we found that this classic triple for-loop approach suffers from
<strong><a href="http://en.wikipedia.org/wiki/Locality_of_reference">poor locality</a></strong>.</p>

<p><img src="/images/pepe.png" alt="psad" />
OMG, who would have known? Our algorithms actually sometimes need to be cache-aware.</p>

<p>This time around we will look at the tall cache
assumption along with <a href="https://en.wikipedia.org/wiki/Loop_tiling">loop-tiling</a> applied to parallel and
sequential MMM. As you would expect there are also some pretty
benchmarks involved.</p>

<h2>Cache-Awareness, So Confuse</h2>

<p>In easy terms, most of the transfers between cache and disk simply involve blocks of data. Whereby the disk is partitioned into blocks of <strong>B</strong> elements each, and accessing one element on disk copies its entire block to cache. When assuming a tall cache, the cache can store up to <strong>M/B</strong> blocks, for a total size of <strong>M</strong> elements, <strong>M &#8805; B&sup2;</strong>.</p>

<p>Meaning when the cache is already full and a block is grabbed from disk, then another block will be evicted from cache. Before exploring something more cache-aware let us demonstrate this occurring in our naive (and cache-oblivious) solution. Assuming square matrices which do not fit into a tall cache then</p>

<p style="text-align:center;">n = rowAmountOfA = colAmountOfA = rowAmountOfB</p>

<p style="text-align:center;">n > M/B</p>

<p>Bellow we see the row-major layout of matrices <strong>A</strong> and <strong>B</strong>. We depict the red rectangles in matrix <strong>B</strong> as our blocks of cache. For all rows of matrix <strong>A</strong> we traverse over each column of <strong>B</strong>. Upon traversing <strong>B</strong> the accessing of each element is cached. Given that <strong>n = colAmountOfA</strong> and <strong>n > M/B</strong> then before the traversal of a column <strong>B</strong> completes the first, and possibly several subsequent, cached blocks of <strong>B</strong> will be evicted. So upon the next and remaining traversals of <strong>B</strong> we incur cache-misses on each block</p>

<p><img src="/images/naive.png" alt="m" /></p>

<p>From this we can be quite clever and infer that a naive algorithm with <strong>n > M/B</strong> results gets the following work done</p>

<p style="text-align:center;">Q(n) = Θ(n<sup>3</sup>)</p>

<p>Which implies that a naive algorithm with <strong>n &#8804; M/B</strong> will get the following work done since the second matrix can now exploit spatial locality</p>

<p style="text-align:center;">Q(n) = Θ(n<sup>3</sup>)/B</p>

<h2>Loop-Tiling, Feels Good</h2>

<p>Lets take a look at a standard <a href="https://en.wikipedia.org/wiki/Loop_tiling">tiling</a> solution to resolve our cache capacity misses.
<img src="/images/good.png" alt="good" /></p>

<p>Pro tip: <em>loop-tiling is a type of loop transformation on which many cache blocking algorithms are built.</em></p>

<p>It involves a combination of strip-mining and interchange in multiply-nested loops, in turn strip-mines several nested loops and performs interchanges to bring the strip-loops inward.</p>

<p>This following tiling solution ensures greater spatial locality for accesses across matrix <strong>B</strong>. Simple but effective, our implementation partitions the matrices’ iteration space though such strip mining and loop interchange</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">s</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">ceil</span><span class="o">(</span><span class="n">rowAmount1</span> <span class="err">∗</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">4</span><span class="o">);</span>
<span class="n">s2</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">ceil</span><span class="o">(</span><span class="n">colAmount1</span> <span class="err">∗</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">4</span><span class="o">);</span>
<span class="n">s3</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">ceil</span><span class="o">(</span><span class="n">rowAmount2</span> <span class="err">∗</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">4</span><span class="o">);</span>
<span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rowAmount1</span> <span class="o">/</span> <span class="n">s</span><span class="o">;</span> <span class="n">i</span><span class="o">+=</span><span class="n">s</span><span class="o">){</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">colAmount1</span> <span class="o">/</span> <span class="n">s2</span><span class="o">;</span> <span class="n">j</span><span class="o">+=</span><span class="n">s2</span><span class="o">){</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">rowAmount2</span> <span class="o">/</span><span class="n">s3</span><span class="o">;</span> <span class="n">k</span><span class="o">+=</span><span class="n">s3</span><span class="o">){</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">i2</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span> <span class="n">i2</span> <span class="o">&lt;</span> <span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="n">s</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">i2</span> <span class="o">&lt;</span> <span class="n">rowAmount1</span><span class="o">;</span> <span class="n">i2</span><span class="o">++){</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">j2</span> <span class="o">=</span> <span class="n">j</span><span class="o">;</span> <span class="n">j2</span> <span class="o">&lt;</span> <span class="o">(</span><span class="n">j</span><span class="o">+</span><span class="n">s2</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">j2</span> <span class="o">&lt;</span> <span class="n">colAmount1</span><span class="o">;</span> <span class="n">j2</span><span class="o">++){</span>
          <span class="k">for</span> <span class="o">(</span><span class="n">k2</span> <span class="o">=</span> <span class="n">k</span><span class="o">;</span> <span class="n">k2</span> <span class="o">&lt;</span> <span class="o">(</span><span class="n">k</span><span class="o">+</span><span class="n">s3</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">k2</span> <span class="o">&lt;</span> <span class="n">rowAmount2</span><span class="o">;</span> <span class="n">k2</span><span class="o">++){</span>
            <span class="n">C</span><span class="o">[</span><span class="n">i2</span><span class="o">][</span><span class="n">j2</span><span class="o">]</span> <span class="o">+=</span> <span class="o">(</span><span class="n">A</span><span class="o">[</span><span class="n">i2</span><span class="o">][</span><span class="n">k2</span><span class="o">]</span> <span class="err">∗</span> <span class="n">B</span><span class="o">[</span><span class="n">k2</span><span class="o">][</span><span class="n">j2</span><span class="o">]);</span>
                          <span class="o">....</span></code></pre></div>


<p>Although not implemented recursively, tiling shares some similarities to the divide-and-conquer approach in that it aims to refine the problem size through partitioning the problems (matrices) into subproblems (submatrices). The design of the tiling solution quite naturally lends itself to parallelisation. Such is implemented as follows</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">s</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">ceil</span><span class="o">(</span><span class="n">rowAmount1</span> <span class="err">∗</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">4</span><span class="o">);</span>
<span class="n">s2</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">ceil</span><span class="o">(</span><span class="n">colAmount1</span> <span class="err">∗</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">4</span><span class="o">);</span>
<span class="n">s3</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">ceil</span><span class="o">(</span><span class="n">rowAmount2</span> <span class="err">∗</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">4</span><span class="o">);</span>
<span class="n">executor</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
<span class="k">for</span><span class="o">(</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">10</span><span class="o">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">rowAmount1</span><span class="o">,</span>
    <span class="n">size</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">ceil</span><span class="o">(</span><span class="n">rowAmount1</span> <span class="err">∗</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">10</span><span class="o">);</span>
    <span class="n">interval</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span> <span class="n">interval</span><span class="err">−−</span><span class="o">,</span> <span class="n">end</span> <span class="err">−</span><span class="o">=</span> <span class="n">size</span><span class="o">){</span>
  <span class="n">to</span> <span class="o">=</span> <span class="n">end</span><span class="o">;</span>
  <span class="n">from</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">end</span> <span class="err">−</span> <span class="n">size</span><span class="o">);</span>
  <span class="n">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Runnable</span><span class="o">(){</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">from</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">to</span> <span class="o">/</span> <span class="n">s</span><span class="o">;</span> <span class="n">i</span><span class="o">+=</span><span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">colAmount1</span> <span class="o">/</span> <span class="n">s2</span><span class="o">;</span> <span class="n">j</span><span class="o">+=</span><span class="n">s2</span><span class="o">){</span>
          <span class="k">for</span> <span class="o">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">rowAmount2</span> <span class="o">/</span><span class="n">s3</span><span class="o">;</span> <span class="n">k</span><span class="o">+=</span><span class="n">s3</span><span class="o">){</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">i2</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span> <span class="n">i2</span> <span class="o">&lt;</span> <span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="n">s</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">i2</span> <span class="o">&lt;</span> <span class="n">rowAmount1</span><span class="o">;</span> <span class="n">i2</span><span class="o">++){</span>
              <span class="k">for</span> <span class="o">(</span><span class="n">j2</span> <span class="o">=</span> <span class="n">j</span><span class="o">;</span> <span class="n">j2</span> <span class="o">&lt;</span> <span class="o">(</span><span class="n">j</span><span class="o">+</span><span class="n">s2</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">j2</span> <span class="o">&lt;</span> <span class="n">colAmount1</span><span class="o">;</span> <span class="n">j2</span><span class="o">++){</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">k2</span> <span class="o">=</span> <span class="n">k</span><span class="o">;</span> <span class="n">k2</span> <span class="o">&lt;</span> <span class="o">(</span><span class="n">k</span><span class="o">+</span><span class="n">s3</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">k2</span> <span class="o">&lt;</span> <span class="n">rowAmount2</span><span class="o">;</span> <span class="n">k2</span><span class="o">++){</span>
                  <span class="n">C</span><span class="o">[</span><span class="n">i2</span><span class="o">][</span><span class="n">j2</span><span class="o">]</span> <span class="o">+=</span> <span class="o">(</span><span class="n">A</span><span class="o">[</span><span class="n">i2</span><span class="o">][</span><span class="n">k2</span><span class="o">]</span> <span class="err">∗</span> <span class="n">B</span><span class="o">[</span><span class="n">k2</span><span class="o">][</span><span class="n">j2</span><span class="o">]);</span>
                               <span class="o">...</span></code></pre></div>


<p>It is important to note the <strong>s</strong>, <strong>s2</strong> and <strong>s3</strong> parameters to our tiling algorithm. Above we see that they are derived respectively from a matrix dimension divided by 4. They are then later used to determine the dimensions (size <strong>s2</strong>x<strong>s3</strong>) of the submatrix-submatrix multiply tasks to be ran. In the case of a square MMM the submatrices’ dimensions would be <strong>s</strong>x<strong>s</strong>.</p>

<p>We divide up these multiply tasks through from/to bounds - requiring no synchronisation as no mutable data is shared across threads.</p>

<p>Determining values for <strong>s</strong>, <strong>s2</strong> and <strong>s3</strong> is not straight-forward, they ultimately determine the tiling size which in turn demands an accurate estimate of the cache size on your target machine. Assuming square matrices which do not fit into a tall cache then</p>

<p style="text-align:center;">n = rowAmountOfA = colAmountOfA = rowAmountOfB</p>

<p style="text-align:center;">n > M/B</p>

<p>Once we determine <strong>s &#8804; M/B</strong> we can easily decompose submatrices (tiles) from matrix <strong>B</strong> that respect the target cache size</p>

<p><img src="/images/tiled.png" alt="m" /></p>

<p>As you would expect the tiling optimisation still results in <strong>Θ(n<sup>3</sup>)</strong> computations. With an optimal <strong>s</strong> value, <strong>Θ(M<sup>&frac12;</sup>)</strong>, we see an improvement in the amount of work done to that of our naive approach. The tall-cache assumption implies that each submatrix and its data will fit in cache, meaning only cold caches misses should occur per submatrix (<strong>Θ(s<sup>2</sup>/B)</strong>).</p>

<p style="text-align:center;">Θ(n) = Θ((n/s)<sup>3</sup>(s<sup>3</sup>)) = Θ(n<sup>3</sup>)</p>

<p style="text-align:center;">Q(n) = Θ((n/s)<sup>3</sup>(s<sup>2</sup>/B)) = Θ(n<sup>3</sup>/BM<sup>&frac12;</sup>)</p>

<p>From the above, as you might have guessed, we can see that <strong>s</strong> is actually a &ldquo;tuning&rdquo; parameter for cache-awareness. In our solution this tiling dividend is set to 4 which, from some rudimentary testing, is the optimal value on recent i5 and i7 processors (OS X 10.10).</p>

<h2>Dem Benchmarks: What was measured?</h2>

<p>Our benchmarking goal was to analyse the trends displayed across the executions of naive MMM and cache-aware MMM in conjunction with parallelisation. Thus the benchmarking process undertaken had the following features:</p>

<ol>
<li>A varying set of dimensions for <strong>A</strong> and <strong>B</strong> respectively on both algorithms were used to identify trends. The dimensions (200x200), (200x300), (1000x1000) and (1000x1200) were used.</li>
<li>To maintain measurement accuracy the elements held by <strong>A</strong> and <strong>B</strong> needed to be the same for each measurement. Every element held by <strong>A</strong> is always 2, while each element in <strong>B</strong> is always 3.</li>
<li>Each benchmark was conducted on two machines (4 core and 8 cores) under the same conditions (no other user processes running, machines connected to power outlets, etc.)</li>
</ol>


<p><img src="/images/i5.png" alt="m" /></p>

<p><img src="/images/i7.png" alt="m" /></p>

<h2>Dem Results</h2>

<p>Reflecting on the mean (μ) execution-time and according standard deviation (σ) provided by our benchmark runs, the collated results are as follows</p>

<p><img src="/images/res.png" alt="m" /></p>

<p>Our data poses several interesting avenues of investigation. However our main concern is exploring the benefits of cache-aware algorithms, so lets just explore the performance differences between both algorithms across runs. The bellow sidebar chart illustrates an obvious difference in our algorithms, at a glance one can see that there is large deviation between the naive and tiled time results.</p>

<p><img src="/images/data.png" alt="m" /></p>

<p>This is particularly true across the benchmarks where matrix dimensions are in their thousands. Such is unsurprising given that the naive algorithm is cache-oblivious. When viewing every sidebar related to the tiled results we can see that varying matrix dimensions do not greatly affect performance. Interestingly, we see that an increase in cores only greatly benefits the naive algorithm. It sees around a 55% improvement in execution-time with the assistance of 4 extra cores across all dimension sizes.</p>

  
  
</div><!-- /.entry-content -->





</article><!-- /.hentry -->

<article class="hentry">
  



<header>
  <div class="entry-meta">
    <span class="entry-date date published updated">
      <time datetime="2015-06-07T17:12:21+01:00">
        <a href="/blog/2015/06/07/matrix-multiply-naive-vs-cache-aware-approaches-1/">June 07, 2015</a>
      </time>
    </span>
<!--     <span class="author vcard">
      <span class="fn">
        <a href="" title="About - Proud Torrenter of Software - All Rights Reserved">- Proud Torrenter of Software - All Rights Reserved</a>
      </span>
    </span> -->
    
      &nbsp; &bull; &nbsp;<span class="entry-comments">
        <a href="/blog/2015/06/07/matrix-multiply-naive-vs-cache-aware-approaches-1/#disqus_thread">Comment</a>
      </span>
    
  </div><!-- /.entry-meta -->
  
    <h1 class="entry-title">
      <a href="/blog/2015/06/07/matrix-multiply-naive-vs-cache-aware-approaches-1/" rel="bookmark" title="Matrix Multiply: Naive Vs Cache-Aware Approaches (Part 1)" itemprop="url">Matrix Multiply: Naive Vs Cache-Aware Approaches (Part 1)</a>
    </h1>
  
</header>

<div class="entry-content">
  <h2>Why, Why, Why?</h2>

<p>Before undertaking my postgraduate studies I led a quite joyous and sheltered life. Living the high life in the worlds of Ruby, Javascript, Python, Java and all of those sorts. My life got flipped-turned upside down when I began studying subjects like Secure Programming, Concurrent Programming and Formal Methods. For me, the biggest take-aways from these learnings were <a href="http://en.wikipedia.org/wiki/Parallel_algorithm">parallel algorithm design</a> and the <a href="http://en.wikipedia.org/wiki/Locality_of_reference">principle of locality</a>.
<img src="/images/fresh.png" alt="fresh" /></p>

<p>Most dense linear algebraic computations rely on the consideration of both spatial and temporal locality. If you are unfamiliar with locality, the former describes the tendency of applications to reference memory addresses that are near other recently accessed addresses and the latter describes the amount of reuse of the same memory locations.</p>

<p>One such linear algebra problem subject to this is dense <a href="http://en.wikipedia.org/wiki/Matrix_multiplication">Matrix-Matrix multiplication (MMM)</a>. Coincidentally MMM is also highly highly parallelisable so it is a perfect to demonstrate <a href="http://en.wikipedia.org/wiki/Parallel_algorithm">parallel algorithm design</a> and the <a href="http://en.wikipedia.org/wiki/Locality_of_reference">principle of locality</a>.</p>

<h2>Matrix Multiply, Ain&rsquo;t Nobody Got Time For That</h2>

<p>Matrix multiplication is important, it is actually central to many scientific computations. For instance, solving a linear system or least-square fits of coefficients to data rely on MMM implementations for good performance.</p>

<p>As you would expect, the performance of an MMM implementation is intimately related to the memory layout of the arrays. On modern shared-memory multiprocessors with multi-level memory hierarchies, naive access patterns in the memory hierarchy can incur cache capacity misses.</p>

<h2>Matrix Multiply, How Tho?</h2>

<p>MMM for square matrices has the following mathematical definition (which is independent of any implementation). Given two n x n matrices A and B, the sum and product</p>

<p style="text-align:center;">C + A ·B</p>

<p>For non-square matrices MMM differs in that the amount of columns in
matrix A must equal equal the amount of rows in B.</p>

<h2>Naive Matrix-Matrix Multiply</h2>

<p>The most naive algorithm for MMM comes straight from the above definition and mimics computing the product by hand. Assuming the arrays are stored such that rows of the arrays are in consecutive memory locations, i.e. row-major order, then we derive C as follows</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rowAmount1</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">colAmount1</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">rowAmount2</span><span class="o">;</span> <span class="n">k</span><span class="o">++)</span>
            <span class="n">C</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span> <span class="o">+=</span> <span class="o">(</span><span class="n">A</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">k</span><span class="o">]</span> <span class="err">∗</span> <span class="n">B</span><span class="o">[</span><span class="n">k</span><span class="o">][</span><span class="n">j</span><span class="o">]);</span></code></pre></div>


<p>This algorithm is said to be naive because it suffers from poor locality. Elements of B are accessed column-wise, and therefore not in sequential order in memory. While each iteration in j reuses row i of A, that row may have been evicted from the cache by the time the inner-most loop completes. As a result, the algorithm is bandwidth limited and displays poor performance and low efficiency.</p>

<p>As we highlighted before, matrix multiplications have abundant parallel computation. While maintaining the less favourable design of this naive approach, let us introduce a parallelised implementation</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">executor</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span> <span class="o">;</span>
<span class="k">for</span> <span class="o">(</span><span class="n">interval</span> <span class="o">=</span> <span class="n">numTasks</span><span class="o">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">rowAmount1</span><span class="o">,</span>
        <span class="n">size</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">ceil</span><span class="o">(</span><span class="n">rowAmount1</span> <span class="err">∗</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">10</span><span class="o">);</span>
        <span class="n">interval</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span> <span class="n">interval</span><span class="err">−−</span><span class="o">,</span> <span class="n">end</span> <span class="err">−</span><span class="o">=</span> <span class="n">size</span><span class="o">){</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">to</span> <span class="o">=</span> <span class="n">end</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">from</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">end</span> <span class="err">−</span> <span class="n">size</span><span class="o">);</span>
    <span class="n">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Runnable</span><span class="o">(){</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">from</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">to</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">colAmount1</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span>
                    <span class="k">for</span> <span class="o">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">rowAmount2</span><span class="o">;</span> <span class="n">k</span><span class="o">++)</span>
                        <span class="n">C</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span> <span class="o">+=</span> <span class="o">(</span><span class="n">A</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">k</span><span class="o">]</span> <span class="err">∗</span> <span class="n">B</span><span class="o">[</span><span class="n">k</span><span class="o">][</span><span class="n">j</span><span class="o">]);</span>
        <span class="o">}</span>
    <span class="o">};</span>
    <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">runnable</span><span class="o">);</span>
<span class="o">}</span></code></pre></div>


<p>We must manually divide the work up into tasks and provide each task with its from/to bounds. Each task will run the entire outer loop but for only specific non-overlapping values. Thus there is no synchronisation in this implementation as no mutable data is shared across threads. The input arrays A and B are not mutated. While the contents of output array C are altered, each thread works on different slices.</p>

<h2>What&rsquo;s The Actual Damage Tho?</h2>

<p>When working with most matrix sizes this approach sees significant improvements in execution time against its sequential counterpart. However as you may expect these improvements are not linear against different matrix sizes.</p>

<p>The basic flaw of the naive triple-for-loop implementation is that the size of its per-loop working set prevents bandwidth amplification from the closest levels of the memory hierarchy, i.e. even with this parallelised horizontal-slicing approach the algorithm <strong>still suffers from poor locality</strong>.</p>

<h2>Until Next Time</h2>

<p><img src="/images/will.png" alt="will" />
Later on we shall investigate some fun stuff like Cache-Awareness and the Tall-Cache Assumption. Of course we&rsquo;ll then develop a cache-aware MMM algorithm using a &ldquo;tiling&rdquo; approach. Finally we will see some pretty benchmark graphs that demonstrate how our algorithms fared across different matrix sizes over a different number of cores.</p>

  
  
</div><!-- /.entry-content -->





</article><!-- /.hentry -->

<article class="hentry">
  



<header>
  <div class="entry-meta">
    <span class="entry-date date published updated">
      <time datetime="2015-05-13T20:50:05+01:00">
        <a href="/blog/2015/05/13/babys-first-sinatra-app/">May 13, 2015</a>
      </time>
    </span>
<!--     <span class="author vcard">
      <span class="fn">
        <a href="" title="About - Proud Torrenter of Software - All Rights Reserved">- Proud Torrenter of Software - All Rights Reserved</a>
      </span>
    </span> -->
    
      &nbsp; &bull; &nbsp;<span class="entry-comments">
        <a href="/blog/2015/05/13/babys-first-sinatra-app/#disqus_thread">Comment</a>
      </span>
    
  </div><!-- /.entry-meta -->
  
    <h1 class="entry-title">
      <a href="/blog/2015/05/13/babys-first-sinatra-app/" rel="bookmark" title="Baby's First Sinatra App" itemprop="url">Baby's First Sinatra App</a>
    </h1>
  
</header>

<div class="entry-content">
  <p><img src="/images/sorry.png" alt="sorry" /></p>

<h2>I&rsquo;m Totally Sorry</h2>

<p>Oops, seems I haven&rsquo;t actually followed through on my commitment to
write a blog post every month, shame on me!</p>

<h2>Down to Bizness</h2>

<p>Lets start off by creating something difficult. An application that is
incredibly useful, original, cutting-edge and technically challenging to develop.
What else could it be but a <strong>TODO list</strong> of course.</p>

<p><img src="/images/bizcat.png" alt="bizcat" />
From scratch we are going develop a TODO list API with <a href="http://www.sinatrarb.com/">Sinatra</a>. If you are unfamiliar with Sinatra it is simply a small web framework for Ruby, somewhat like Ruby on Rails. As Sinatra is built on top of <a href="http://rack.github.io/">Rack</a> we can then easily deploy our completed app to <a href="https://www.heroku.com/">Heroku</a>.</p>

<p>This tutorial expects that you have some grounding in Ruby and understand basic <a href="http://www.ibm.com/developerworks/library/ws-restful/">RESTful API</a> design. We will be using Ruby 2.1.2 but any Ruby version post-2.0 should be fine.</p>

<h2>Setting up your dependencies</h2>

<p>Even in a small project nobody likes managing their own dependencies, it really can be terrible so lets reach for <a href="http://bundler.io/">Bundler</a>, which essentially frees you from dependency hell by making sure your application runs the same code on every machine.</p>

<p>First we need to install the Bundler gem.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>gem install bundler</code></pre></div>


<p>We then must define our according <a href="http://bundler.io/man/gemfile.5.html">Gemfile</a>, a Ruby file placed at the root of your directory for describing your gem (package) dependencies.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
<span class="c1"># ruby &#39;2.1.2&#39; # tested with 2.1.2 but other versions should be fine</span>

<span class="n">gem</span> <span class="s1">&#39;sinatra&#39;</span><span class="p">,</span> <span class="s1">&#39;1.4.2&#39;</span> <span class="c1"># web framework</span>
<span class="n">gem</span> <span class="s1">&#39;sinatra-contrib&#39;</span><span class="p">,</span> <span class="s1">&#39;1.4.2&#39;</span> <span class="c1"># web framework extensions</span>

<span class="n">gem</span> <span class="s1">&#39;data_mapper&#39;</span> <span class="c1"># lightweight ORM</span>

<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;dm-sqlite-adapter&#39;</span> <span class="c1"># local DB ORM adapter</span>
  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span> <span class="c1"># local DB</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
 <span class="n">gem</span> <span class="s1">&#39;pg&#39;</span> <span class="c1"># prod DB</span>
 <span class="n">gem</span> <span class="s1">&#39;dm-postgres-adapter&#39;</span> <span class="c1"># prod DB ORM adapter</span>
 <span class="n">gem</span> <span class="s1">&#39;unicorn&#39;</span> <span class="c1"># prod application server</span>
<span class="k">end</span></code></pre></div>


<p>Finally we must install our required gems with Bundler.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>bundle install --without production</code></pre></div>


<h2>Say Harro World!</h2>

<p>Great, we have our dependencies in place so we better verify that everything is
working as expected. Any Ruby file which requires or loads the Sinatra library, with at least
one endpoint defined, can be conveniently executed as a <a href="http://en.wikipedia.org/wiki/WEBrick">WEBrick</a> server.</p>

<p>Lets simply define one route or endpoint and test it out.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;sinatra&#39;</span>

<span class="n">get</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
  <span class="s2">&quot;LOLOLOL! You rock!&quot;</span>
<span class="k">end</span></code></pre></div>


<p>Like any other Ruby script, we can execute it with the <code>ruby</code> command.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>ruby proof.rb</code></pre></div>


<p>As you would expect <code>proof.rb</code> begins to run on a default port and we see the desired response on
<a href="http://localhost:4567/.">http://localhost:4567/.</a> Among other things, we can easily change this target port number by
passing a flag argument to the script.</p>

<p>A list of the available flags can be outputted by passing <code>-h</code> as an argument.</p>

<h2>App Environment Cruft</h2>

<p>Lets now create our cleverly named main application file, <code>app.rb</code>. We need to then first require our library modules.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Require the bundler gem and then call Bundler.require to load in all gems</span>
<span class="c1"># listed in Gemfile.</span>
<span class="nb">require</span> <span class="s1">&#39;bundler&#39;</span>
<span class="no">Bundler</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:default</span><span class="p">,</span> <span class="ss">:development</span><span class="p">)</span> <span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="no">Bundler</span><span class="p">)</span>
<span class="c1"># Reload app.js when changed</span>
<span class="nb">require</span> <span class="s2">&quot;sinatra/reloader&quot;</span> <span class="k">if</span> <span class="n">development?</span></code></pre></div>


<p>Using <code>Bundler.require</code> we tell Bundler to load those modules in the gem groups named development and default, where the latter is all of those gems not contained in the development or production groups.</p>

<p>Remember our dependency <a href="http://www.sinatrarb.com/contrib">sinatra-contrib</a>? It just contains lots of nice extensions for Sinatra. One of which no one should live without is <a href="http://www.sinatrarb.com/contrib/reloader.html">Sinatra::Reloader</a>. It automatically reloads all files required by your application which of course we need during development.</p>

<h2>Models, Models Everywhere</h2>

<p>We are using <a href="http://datamapper.org/why.html">DataMapper</a> as our ORM. In terms of our requirements its main appeal
is the ever useful <code>auto_migrate!</code> feature which creates your datastore schema based
off your defined <code>DataMapper::Resource</code> models, removing the need to write and manage migrations.</p>

<p>Now we must create our local <a href="https://www.sqlite.org/">SQLite</a> DB and establish a connection.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># DB init</span>
<span class="no">DataMapper</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="ss">:default</span><span class="p">,</span> <span class="s2">&quot;sqlite3://</span><span class="si">#{</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="si">}</span><span class="s2">/development.db&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">development?</span></code></pre></div>


<p>With such in place we can now define our naive <code>Task</code> which models a TODO list item. Similar to <a href="http://guides.rubyonrails.org/active_record_basics.html">ActiveRecord</a>, in DataMapper the convention with model names is to use the singular version of the name. Though unlike ActiveRecord, DataMapper does not enforce this.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Models</span>
<span class="k">class</span> <span class="nc">Task</span>
  <span class="kp">include</span> <span class="no">DataMapper</span><span class="o">::</span><span class="no">Resource</span>

  <span class="n">property</span> <span class="ss">:id</span><span class="p">,</span> <span class="no">Serial</span><span class="p">,</span> <span class="ss">key</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">property</span> <span class="ss">:name</span><span class="p">,</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">required</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">property</span> <span class="ss">:completed_at</span><span class="p">,</span> <span class="no">DateTime</span>
  <span class="n">property</span> <span class="ss">:created_at</span><span class="p">,</span> <span class="no">DateTime</span>
<span class="k">end</span>
<span class="c1"># Finalize and migrate</span>
<span class="no">DataMapper</span><span class="o">.</span><span class="n">finalize</span><span class="o">.</span><span class="n">auto_upgrade!</span></code></pre></div>


<p>Before using our model we must first <code>finalize</code>. This checks the validity of all of our DataMapper model definitions and initializes all properties associated with relationships. This nicely returns its caller, <code>DataMapper</code>, so we can chain a call to <code>auto_upgrade!</code> which issues the necessary CREATE statement for our task table if it does not already exist.</p>

<p>Now lets verify that our model is in fact persistent and working as expected. We can simply execute script and our DB will be in place. Lets query the current amount of task rows.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>ruby -r ./app.rb -e <span class="s2">&quot;puts Task.all.size&quot;</span></code></pre></div>


<h2>Gimme Them Endpoints</h2>

<p>In Sinatra we can define endpoints that are a combination of a HTTP verb and the according request path. Which as you can see results in succinct and pretty code ♥</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Api</span>
<span class="n">get</span> <span class="s1">&#39;/task/&#39;</span> <span class="k">do</span>
  <span class="n">content_type</span> <span class="ss">:json</span>

  <span class="vi">@tasks</span> <span class="o">=</span> <span class="no">Task</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">order</span><span class="p">:</span> <span class="ss">:created_at</span><span class="o">.</span><span class="n">desc</span><span class="p">)</span>
  <span class="vi">@tasks</span><span class="o">.</span><span class="n">to_json</span>
<span class="k">end</span></code></pre></div>


<p>Upon a defined endpoint being accessed, a <code>before</code> code block is ran if defined. This is a simple before-request hook, we do not avail of it for our endpoints. Upon its successful termination, the user-defined block on that endpoint will be executed.</p>

<p>Above we simply return a JSON list of all the task rows. We can verify this endpoint by simply executing <code>curl http://localhost:4567/task/</code>. As expected the body of our response is an empty array.</p>

<p>Now we can define our remaining endpoints for POST, GET,PUT and DELETE.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">post</span> <span class="s1">&#39;/task/&#39;</span> <span class="k">do</span>
  <span class="n">content_type</span> <span class="ss">:json</span>

  <span class="vi">@task</span> <span class="o">=</span> <span class="no">Task</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">permit_params</span><span class="p">)</span>
  <span class="vi">@task</span><span class="o">.</span><span class="n">save</span> <span class="p">?</span> <span class="vi">@task</span><span class="o">.</span><span class="n">to_json</span> <span class="p">:</span> <span class="n">halt</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">put</span> <span class="s1">&#39;/task/:id&#39;</span> <span class="k">do</span>
  <span class="n">content_type</span> <span class="ss">:json</span>

  <span class="vi">@task</span> <span class="o">=</span> <span class="no">Task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">].</span><span class="n">to_i</span><span class="p">)</span>
  <span class="vi">@task</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">permit_params</span><span class="p">)</span>

  <span class="vi">@task</span> <span class="o">&amp;&amp;</span> <span class="vi">@task</span><span class="o">.</span><span class="n">save</span> <span class="p">?</span> <span class="vi">@task</span><span class="o">.</span><span class="n">to_json</span> <span class="p">:</span> <span class="n">halt</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">&#39;/task/:id&#39;</span> <span class="k">do</span>
  <span class="n">content_type</span> <span class="ss">:json</span>

  <span class="vi">@task</span> <span class="o">=</span> <span class="no">Task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">].</span><span class="n">to_i</span><span class="p">)</span>
  <span class="vi">@task</span> <span class="p">?</span> <span class="vi">@task</span><span class="o">.</span><span class="n">to_json</span> <span class="p">:</span> <span class="n">halt</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">delete</span> <span class="s1">&#39;/task/:id&#39;</span> <span class="k">do</span>
  <span class="n">content_type</span> <span class="ss">:json</span>

  <span class="vi">@task</span> <span class="o">=</span> <span class="no">Task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">].</span><span class="n">to_i</span><span class="p">)</span>
  <span class="vi">@task</span> <span class="o">&amp;&amp;</span> <span class="vi">@task</span><span class="o">.</span><span class="n">destroy</span> <span class="p">?</span> <span class="p">{</span> <span class="ss">success</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">to_json</span> <span class="p">:</span> <span class="n">halt</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">permit_params</span>
  <span class="n">params</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="o">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;completed_at&quot;</span><span class="o">].</span><span class="n">include?</span> <span class="n">k</span> <span class="p">}</span>
<span class="k">end</span></code></pre></div>


<h2>Data, Not Enough Data</h2>

<p>Before we deploy to Heroku it would be nice to have a prepopulated API in place, so lets just seed two tasks.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Seed</span>
<span class="k">if</span> <span class="no">Task</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span>
  <span class="no">Task</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Test Task One&quot;</span><span class="p">)</span>
  <span class="no">Task</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Test Task Two&quot;</span><span class="p">)</span>
<span class="k">end</span></code></pre></div>


<p>Again, we can verify this by executing <code>curl http://localhost:4567/task/</code> and see our listed tasks.</p>

<h2>Ship First, Test Later</h2>

<p>Lets put this thing of beauty out there! The usual tweaks are required for our Heroku deploy. We need to parameterize
what gems are required and what DataMapper connection we wish to use per environment.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Bundler</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:default</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RACK_ENV&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="ss">:development</span><span class="p">)</span> <span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="no">Bundler</span><span class="p">)</span>

<span class="k">if</span> <span class="n">development?</span>
  <span class="no">DataMapper</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="ss">:default</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;DATABASE_URL&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="s2">&quot;sqlite3://</span><span class="si">#{</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="si">}</span><span class="s2">/development.db&quot;</span><span class="p">)</span>
<span class="k">elsif</span> <span class="n">production?</span>
  <span class="no">DataMapper</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="ss">:default</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;DATABASE_URL&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="s1">&#39;postgres://localhost/sinatra-todos&#39;</span><span class="p">)</span>
<span class="k">end</span></code></pre></div>


<p>We then need to create a <a href="https://devcenter.heroku.com/articles/rack">rakeup file</a> named <code>config.ru</code> to instruct Heroku how to run our Rack app.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;./app&#39;</span>
<span class="n">run</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Application</span></code></pre></div>


<p>Finally, we must setup a repository, add a <a href="https://devcenter.heroku.com/articles/git">Heroku remote</a> and push our work to deploy the app.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">git init <span class="o">&amp;&amp;</span> git add --all <span class="o">&amp;&amp;</span> git commit -m <span class="s2">&quot;initial&quot;</span>
heroku create
git push heroku master</code></pre></div>




  
  
</div><!-- /.entry-content -->





</article><!-- /.hentry -->

<article class="hentry">
  



<header>
  <div class="entry-meta">
    <span class="entry-date date published updated">
      <time datetime="2014-08-04T19:54:57+01:00">
        <a href="/blog/2014/08/04/it-has-begun/">August 04, 2014</a>
      </time>
    </span>
<!--     <span class="author vcard">
      <span class="fn">
        <a href="" title="About - Proud Torrenter of Software - All Rights Reserved">- Proud Torrenter of Software - All Rights Reserved</a>
      </span>
    </span> -->
    
      &nbsp; &bull; &nbsp;<span class="entry-comments">
        <a href="/blog/2014/08/04/it-has-begun/#disqus_thread">Comment</a>
      </span>
    
  </div><!-- /.entry-meta -->
  
    <h1 class="entry-title">
      <a href="/blog/2014/08/04/it-has-begun/" rel="bookmark" title="it-has-begun" itemprop="url">it-has-begun</a>
    </h1>
  
</header>

<div class="entry-content">
  <p><img class="right" src="/images/coming.jpg" width="280" height="280"  ></p>

<p>Ah yes, after much procrastination I have finally gotten around to my first blog post. I now faithfully
vow to post at least one blog entry per month ♥</p>

  
  
</div><!-- /.entry-content -->





</article><!-- /.hentry -->


<div class="pagination">
  
  <a href="/archives">Blog Archives</a>
  
</div><!-- /.pagination -->

  </div><!-- /#main -->

  <div class="footer-wrapper">
    <footer role="contentinfo">
      <span>&copy; 2018 - Proud Torrenter of Software - All Rights Reserved. Powered by <a href="http://octopress.org">Octopress</a>.</span>

    </footer>
  </div><!-- /.footer-wrapper -->

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/javascripts/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<!--
<script src="//javascripts/octopress.js" type="text/javascript"></script>
-->
<script src="/javascripts/scripts.min.js"></script>




  

</body>
</html>
